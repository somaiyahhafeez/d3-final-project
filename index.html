<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mapping NYC’s Foreign-Born Communities</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root { color-scheme: light; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:#222; background:#fff; }

    .container { max-width: 960px; margin: 0 auto; padding: 0 12px; }
    h1 { font-size: 34px; line-height: 1.2; font-weight: 800; margin: 22px 0 6px; }
    h2 { font-weight: 700; font-size: 20px; margin: 14px 0 4px; }
    p { font-size: 16px; margin: 0 0 14px; }

    .map-wrap { max-width: 960px; margin: 24px auto; padding: 0 12px; }
    .map-wrap svg { background: #ffffff; display: block; margin: 0 auto; width:100%; height:auto; }

    .tooltip {
      position: absolute; background: white; border: 1px solid #cfcfcf;
      padding: 6px 8px; pointer-events: none; font-size: 13px; color:#222;
      box-shadow: 0 1px 6px rgba(0,0,0,.18); border-radius:6px;
    }
  </style>
</head>
<body>

  <header class="container">
    <h1>Mapping NYC’s Foreign-Born Communities</h1>
  </header>

  <div class="container">
    <h2>About 40.5% of New York City’s foreign-born population is from Latin America.</h2>
    <p>More than 40% of the city's total population is foreign-born.</p>
  </div>

  <div class="map-wrap">
    <svg id="nyc-map" viewBox="0 0 780 640" aria-label="Map of NYC by top foreign-born subregion"></svg>
  </div>
  <div class="tooltip" style="display:none"></div>

  <script>
    const vbW = 780, vbH = 640;
    const padLeftRight = 12, padTop = 8, padBottom = 8;
    const fmtPct = d3.format(".1f");
    const svgMap = d3.select("#nyc-map");
    const tooltip = d3.select(".tooltip");

    Promise.all([
      d3.json("nynta2020.json"),
      d3.csv("Foreign-born-per-subregion-per-NTA.csv")
    ]).then(([geoData, csvData]) => {
      const pctCols = Object.keys(csvData[0]).filter(k => k.endsWith('_pct') && k.includes('::'));
      const colToName = k => k.replace(/_pct$/, "").split("::").slice(-1)[0];
      const dataMap = new Map(csvData.map(d => [d.NTAName, d]));

      function getTopSubregions(props, n = 2) {
        return pctCols.map(k => ({ name: colToName(k), pct: +props[k] }))
          .filter(d => Number.isFinite(d.pct) && d.pct > 0)
          .sort((a,b) => b.pct - a.pct)
          .slice(0, n);
      }
      const getTop1 = props => getTopSubregions(props, 1)[0];

      geoData.features.forEach(f => {
        const row = dataMap.get(f.properties.NTAName);
        if (row) Object.assign(f.properties, row);
      });

      const used = new Set();
      geoData.features.forEach(f => {
        const row = dataMap.get(f.properties.NTAName);
        if (!row) return;
        const top = getTop1(row);
        if (top) used.add(top.name);
      });
      const domain = Array.from(used).sort(d3.ascending);

      const customColors = {
        "Latin America": "#25486d",
        "Eastern Asia": "#8DA750",
        "Eastern Europe": "#ded1b4",
        "Northern Europe": "#8d021f",
        "South Central Asia": "#d24e01",
        "Southern Africa": "#fab102",
        "Western Asia": "#3b1344",
        "Western Europe": "#05696B"
      };
      const hueScale = d3.scaleOrdinal()
        .domain(domain)
        .range(domain.map(name => customColors[name] || "#ccc"));

      const sq = 14, labelFont = 14, rowGap = 6, labelPadX = 8;
      const legend = svgMap.append("g").attr("class", "legend");
      let yOffset = 0;
      domain.forEach(name => {
        const g = legend.append("g").attr("transform", `translate(0,${yOffset})`);
        g.append("rect").attr("width", sq).attr("height", sq).attr("fill", hueScale(name));
        g.append("text")
          .attr("x", sq + labelPadX).attr("y", sq / 2)
          .attr("dominant-baseline", "middle")
          .style("font-size", `${labelFont}px`)
          .text(name);
        yOffset += sq + rowGap;
      });

      const projection = d3.geoIdentity().reflectY(true);
      projection.fitExtent([[padLeftRight, padTop], [vbW - padLeftRight, vbH - padBottom]], geoData);
      const path = d3.geoPath().projection(projection);

      legend.attr("transform", `translate(${padLeftRight + 10}, ${padTop + 10})`);

      svgMap.append("g")
        .selectAll("path")
        .data(geoData.features)
        .join("path")
        .attr("d", d => path(d))
        .attr("fill", d => {
          const row = dataMap.get(d.properties.NTAName);
          if (!row) return "#eee";
          const top = getTop1(row);
          return top ? hueScale(top.name) : "#eee";
        })
        .attr("stroke", "#ffffff")
        .attr("stroke-width", 1.0)
        .on("mouseover", function(event, d) {
          const name = d.properties.NTAName || "";
          const row  = dataMap.get(name);
          let html = `<strong>${name}</strong>`;
          if (row) {
            const top2 = getTopSubregions(row, 2);
            if (top2.length) {
              const lines = top2.map(x => `${x.name}: ${fmtPct(x.pct)}%`).join("<br>");
              html += `<br>${lines}`;
            }
          } else {
            html += `<br><em>No data</em>`;
          }
          d3.select(this).attr("stroke-width", 1.8);
          tooltip.style("display", "block").html(html);
        })
        .on("mousemove", function(event) {
          if (tooltip.style("display") !== "none") {
            tooltip.style("left", (event.pageX + 10) + "px")
                   .style("top",  (event.pageY + 10) + "px");
          }
        })
        .on("mouseout", function() {
          d3.select(this).attr("stroke-width", 1.0);
          tooltip.style("display", "none");
        });
    });
  </script>
</body>
</html>
